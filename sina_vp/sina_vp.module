<?php
/**
 * @author dale
 * @version $Id$
 * @copyright dale
 * @package sina
 */

/**
 * @file
 * This is an sina_open module extended.
 */
module_load_include('inc', 'node', 'node.pages');//调用节点发布相关

/**
 * Implementation of hook_node_info().
 * Define module-provided node types.
 */
function sina_vp_node_info() {
  $items = array(
    'weibo' => array(
      'name' => t('weibo'),
      'module' => 'sina',
      'description' => 'weibo note type',
      'has_title' => '1',
      'title_label' => t('Title'),
      'has_body' => '1',
      'body_label' => 'Body',
      'help' => 'sina_vp_node_info help',
      'node_options' => array (
        'status' => true,
        'promote' => false,
        'sticky' => false,
        'revision' => false,
      ),
      'comment' => '1',
    ),
  );
  return $items;
}
//If you implement this hook you MUST also implement a hook_form() 
//if you want that node type to appear in the content type list.
/*
 * Implementation of hook_form().
 * Display a node editing form. 
 */
function sina_vp_form(&$node, &$param) 
{
  $node_form = node_content_form($node, $form_state);
  return $node_form;
}

/*
 * Implementation of hook_nodeapi().
 * Act on nodes defined by other modules.
 */
function sina_vp_nodeapi(&$node, $op) 
{
	//copy form sina_open_nodeapi
	if ($op == 'insert' && variable_get('sina_open_node_'.$node->type, 1) && $node->sina_vp_open) {
    global $user;
      if (db_result(db_query('SELECT uid FROM {sina_open_user} WHERE uid = %d', $user->uid))) {
        $url = url('node/'.$node->nid, array('absolute' => true));
        
        sina_open_t_set_tweet2(//dale ,发布图片 add pram @$node->nid callback function sina.module
          $node->sina_vp_open['title'] ? $node->sina_vp_open['title'] : $node->title,
          url('node/'.$node->nid, array('absolute' => true))
		  		,$node //传递节点 dale
        );
				//发布节点后不跳转node页 与简洁链接。dale
				// 需完善 参 http://www.ludou.org/get_current_page_url.html
				//$uri=preg_replace($patterns2, $replacements, $string);
				//str_replace('q=','',$_SERVER['QUERY_STRING']);
				//drupal_goto('vp/user_timeline');
      } else {
        drupal_set_message('您需要先绑定新浪微博帐号，才能够推送信息。', 'error');
      }
  }
  switch( $node->type )
  {
    case 'weibo':
      switch ($op) {
        case 'insert':
		  	$node->body=$node->title;	
	      drupal_write_record('node_revisions', $node, 'vid');	
          break;
        case 'update':
          $node->body=$node->title;	
	      drupal_write_record('node_revisions', $node, 'vid');
          break;
        case 'delete':    
					$wid= sina_vp_get_wid($node->nid);
					$request_url="http://api.t.sina.com.cn/statuses/destroy/$wid.json"; 
					$result = sina_open_t_set_request($request_url);
					if ($result->code == 200) {
						drupal_set_message($message = '同步删除成功！', $type = 'status', $repeat = TRUE);
						db_query("DELETE FROM {sina_vp_weibo2node} WHERE nid = %d", $node->nid); 			
						if(function_exists(dpm)) dpm(json_decode($result->data));			
					} else {
						drupal_set_message($message = '同步删除失败！', $type = 'warning', $repeat = TRUE);
						return false;
					}	       
          break;
        case 'prepare':
          //
          break;
        case 'view':
          break;
        case 'load':
          break;
      }
      break;
	//发布任务跳转列表页
	case 'story':
		 switch ($op) {
	        case 'insert':
		      	drupal_goto('tasklist');	
	          break;
	        case 'update':
	          drupal_goto('tasklist');
	          break;
			 }
	break;
  }
}
/**
 * @Implement of hook_comment()
 * copy form sina_open_comment()
 */
function sina_vp_comment(&$comment, $op) {
	dpm(&$comment);
  if ($op == 'insert' && isset($comment['sina_vp_open']) && variable_get('sina_open_comment', 1)) {
    if($comment['sina_vp_open']) {
      sina_open_t_set_tweet2(
        $comment['subject'],
        url('node/'.$comment['nid'], array('absolute' => true, 'fragment' => 'comment-'. $comment['cid']))
				,$comment //dale 新添comment
      );
    }
  }
}
/**
 * Implementation of hook_perm().
 */
function sina_vp_perm(){
  return array(
		'add new product',//新产品
		'add new activity',//活动
		'add new special',
		'add new sale',
		'add new transfer',
		'add new show',//真人秀
		'add new forward'//转发权
	);
}

/**
 * Implementation of hook_access().
 * del=true

function sina_vp_access($op, $node, $account) {
  switch ($op) {
    case 'create':
      // Anonymous users cannot post even if they have the permission. 
      return user_access('create weibo entries', $account) && $account->uid ? TRUE : NULL;
    case 'update':
      return user_access('edit any weibo entry', $account) || (user_access('edit own weibo entries', $account) && ($node->uid == $account->uid)) ? TRUE : NULL;
    case 'delete':
      return user_access('delete any weibo entry', $account) || (user_access('delete own weibo entries', $account) && ($node->uid == $account->uid)) ? TRUE : NULL;
  }
} */
function sina_vp_init(){
	drupal_add_js(drupal_get_path('module', 'sina_vp') .'/js/wbt-helper.js');
  drupal_add_css(drupal_get_path('module', 'sina_vp') .'/css/sina.user.page.css');
}
/**
 * Implementation of hook_menu().
 */
function sina_vp_menu() {
	$items['vp'] = array(
		'title' => t('Vp'),//'menu_name' => 'primary-links',
		'page callback' => 'sina_vp_public_timeline',
		'access callback' => TRUE,
		'file' => 'sina_vp.pages.inc',
		'weight' => -20,
  );
	$items['vp/public_timeline'] = array(
    'title' => t('public_timeline'),//'menu_name' => 'Secondary_links',
    'page callback' => 'sina_vp_public_timeline',
    'access callback' => TRUE,
    //'access callback' => 'create weibo entries',
    //'access arguments'=>  array('create weibo entries'),
    'description' => t('public_timeline'),
    'file' => 'sina_vp.pages.inc',
    'weight' => -20,
		'type' => MENU_LOCAL_TASK,		
		//'type' => MENU_DEFAULT_LOCAL_TASK,
  );
  $items['vp/user_timeline'] = array(
    'title' => t('user_timeline'),//'menu_name' => 'Secondary_links',
    'page callback' => 'sina_vp_user_timeline',
    'access callback' => TRUE,
    'description' => t('public_timeline'),
    'file' => 'sina_vp.pages.inc',
    'weight' => -20,
		'type' => MENU_LOCAL_TASK,
  );
	$items['vp/friend_timeline'] = array(
    'title' => t('friend_timeline'),//'menu_name' => 'Secondary_links',
    'page callback' => 'sina_vp_friend_timeline',
    'access callback' => TRUE,
    'description' => t('friend_timeline'),
    'file' => 'sina_vp.pages.inc',
    'weight' => -19,
		'type' => MENU_LOCAL_TASK,
  );
  $items['vp/weibo_page_default/comment_ahah_callback/%'] = array(//评论
    'page callback' => 'weibo_page_default_callback',
    'page arguments' => array(3),
    'access callback' => TRUE,
    'file' => 'sina_comment_ahah.inc',
    'type' => MENU_CALLBACK,
  );
	//通过api里的元数据实现不同页面微博发布时的tags记录来区分是那种类型的weibo。
	//新品，活动，爆款，，转让，真人秀
	$items['vp/add/Product'] = array(
    'title' => t('新品'),//卖家发布的新品 + 所有该卖家发布的新品页面，即user_timeline
    'page callback' => 'sina_vp_new_content',
    'page arguments' => array(2),
    'access arguments' => array('add new product'),
    'description' => '发布新产品到店铺',
    'file' => 'sina_vp.pages.inc',
    'weight' => -20,
		'type' => MENU_DEFAULT_LOCAL_TASK,
  );	
  $items['vp/add/Activity'] = array(
    'title' => t('活动'),//卖家发布的新品或者活动信息
    'page callback' => 'sina_vp_new_content',
    'page arguments' => array(2),
    'access arguments' => array('add new activity'),
    'description' => '发布店铺活动信息',
    'file' => 'sina_vp.pages.inc',
    'weight' => -19,
		'type' => MENU_DEFAULT_LOCAL_TASK,
  );
	$items['vp/add/Special'] = array(
    'title' => t('爆款'),//卖家发布的新品或者活动信息
    'page callback' => 'sina_vp_new_content',
    'page arguments' => array(2),
    'access arguments' => array('add new special'),
    'description' => '爆款',
    'file' => 'sina_vp.pages.inc',
    'weight' => -18,
		'type' => MENU_DEFAULT_LOCAL_TASK,
  );
	$items['vp/add/Sale'] = array(
    'title' => t('特卖'),//卖家发布的新品或者活动信息
    'page callback' => 'sina_vp_new_content',
    'page arguments' => array(2),
    'access arguments' => array('add new sale'),
    'description' => '特卖',
    'file' => 'sina_vp.pages.inc',
    'weight' => -17,
		'type' => MENU_DEFAULT_LOCAL_TASK,
  );
	$items['vp/add/Transfer/%'] = array(//nid
    'title' => t('转让'),
    'page callback' => 'sina_vp_new_content',
    'page arguments' => array(2,3),
    'access arguments' => array('add new transfer'),
    'description' => '转让',
    'file' => 'sina_vp.pages.inc',
    'weight' => -16,
		'type' => MENU_DEFAULT_LOCAL_TASK,
  );	
  $items['vp/Reality/Show/%'] = array(//nid
    'title' => t('真人秀'),
    'page callback' => 'sina_vp_new_content',
    'page arguments' => array(2,3),
    'access arguments' => array('add new show'),
    'description' => '真人秀',
    'file' => 'sina_vp.pages.inc',
    'weight' => -1,
		'type' => MENU_DEFAULT_LOCAL_TASK,
  );  
  $items['vp/forward/%/%'] = array(//Show/nid
    'title' => t('转发'),
    'page callback' => 'sina_vp_new_forward',
    'page arguments' => array(2,3),
    'access arguments' => array('add new forward'),
    'description' => '转发',
    'file' => 'sina_vp.pages.inc',
    'weight' => -15,
		'type' => MENU_DEFAULT_LOCAL_TASK,
  );
	
	$items['shop/%'] = array( //shop/uid|shop_name
    'title callback' => 'user_shop_title',//不同店长角色的user店铺名称
    'title arguments' => array(1),
    'page callback' => 'sina_vp_user_timeline',
    'access arguments' => array('view shops'),
    'description' => '我的店铺',
    'file' => 'sina_vp.pages.inc',
    'weight' => -20,
		//'type' => MENU_DEFAULT_LOCAL_TASK,
  );
	$items['VpCenter'] = array(
    'title' => t('微铺大厅'),
    'page callback' => 'sina_vp_center_page_default',
    'access callback' => TRUE,
    'description' => '微铺大厅',
    'file' => 'sina_vp_center.inc',
    'weight' => -15,
		//'type' => MENU_DEFAULT_LOCAL_TASK,
  );	
	$items['VpCenter/Product'] = array(
    'title' => t('新品'),
    'page callback' => 'sina_vp_center_page_default',
    'page arguments' => array(1),
    'access callback' => TRUE,
    'description' => '新品',
    'file' => 'sina_vp_center.inc',
    'weight' => -15,
    'type' => MENU_LOCAL_TASK,
  );
	$items['VpCenter/Activity'] = array(
    'title' => t('活动'),
    'page callback' => 'sina_vp_center_page_default',
    'page arguments' => array(1),
    'access callback' => TRUE,
    'description' => '活动',
    'file' => 'sina_vp_center.inc',
    'weight' => -15,
    'type' => MENU_LOCAL_TASK,
  );
	$items['VpCenter/Special'] = array(
    'title' => t('爆款'),
    'page callback' => 'sina_vp_center_page_default',
    'page arguments' => array(1),
    'access callback' => TRUE,
    'description' => '爆款',
    'file' => 'sina_vp_center.inc',
    'weight' => -15,
    'type' => MENU_LOCAL_TASK,
  );	
  $items['VpCenter/Sale'] = array(
    'title' => t('特卖'),
    'page callback' => 'sina_vp_center_page_default',
    'page arguments' => array(1),
    'access callback' => TRUE,
    'description' => '特卖',
    'file' => 'sina_vp_center.inc',
    'weight' => -15,
    'type' => MENU_LOCAL_TASK,
  );
	$items['VpCenter/Transfer'] = array(
    'title' => t('转让'),
    'page callback' => 'sina_vp_center_page_default',
    'page arguments' => array(1),
    'access callback' => TRUE,
    'description' => '转让',
    'file' => 'sina_vp_center.inc',
    'weight' => -15,
    'type' => MENU_LOCAL_TASK,
  );
	$items['VpCenter/Show'] = array(
    'title' => t('真人秀'),
    'page callback' => 'sina_vp_center_page_default',
    'page arguments' => array(1),
    'access callback' => TRUE,
    'description' => '真人秀',
    'file' => 'sina_vp_center.inc',
    'weight' => -15,
    'type' => MENU_LOCAL_TASK,
  );
  return $items;
}

function sina_vp_menu_alter(&$items) {
  // Example - disable the page at node/add
  $items['node/add']['access callback'] = FALSE;
  $items['node/add/weibo']['access callback'] = FALSE;
	$items['vp/add/Transfer']['access callback'] = FALSE;
	$items['vp/add/Show']['access callback'] = FALSE;
}
/**
 * Menu item title callback - use the user name if it's not the current user.
 */
function user_shop_title($account) {
  if ($account->uid == $GLOBALS['user']->uid) {
    return t('My account');
  }
  return $account->name;
}
/**
 * 新添数据库记录关联节点，存储新浪微博元数据. 
 */
function sina_vp_type_preprocess($sina_vp_type){
	switch ($sina_vp_type) {
		case 'value':
			
			break;
		
		default:
			
			break;
	}
	
}

/**
 * weibo数据库写入.
 *
 * @param $data
 * 	新浪微博返回的json data.
 * @param $node
 *   节点或评论
 * @param $sina_vp_type
 *   string weibo频道
 * @param $zid
 *   被转发节点id
 */
function _sina_vp_db_write($data,$node,$sina_vp_type=NUll,$zid=NULL){
		if(isset($node->type)){//if $node is a node 拥有type属性
			$nid = $node->nid;
			$cid = 0;
			$datas = $node->title;
		}elseif(isset($node[cid])){//if is $comment is_array &&cid属性
			$nid = $node[nid];
			$cid = $node[cid];
			$datas = $node[subject];
		}
		global $user;
		if(!empty($data)&&(!is_null($data))){//离线wdata字段为标题
			$wdata = json_decode($data);
			$datas = $data;
		}  
		$wid   = $wdata?$wdata->id:0;
		$created_at = $wdata?strtotime($wdata->created_at):time();
		//
		if(is_string($sina_vp_type)){
			$sina_vp_type=sina_vp_get_type_by_string($sina_vp_type);
		}
		db_query("INSERT INTO {sina_vp_weibo2node}
							(`nid` ,`uid` ,`cid`,`wid` ,`data`,`created_at`,`sina_vp_type`,`zid`)
							VALUES ('%d','%d','%d','%d','%s','%d','%d','%d')"
							,$nid,$user->uid,$cid,$wid,$datas,$created_at,$sina_vp_type,$zid);
							//more... 是否需要分2个表 nid zid
}
/**
 * Implementation of hook_form_alter(). 
 * @Where sina_vp_open_set_tweet_form in sina_open.module
 * @Do before set_tweet ,insert into our Additional db_table sina_weibo2node info.
 */
function sina_vp_form_alter(&$form, $form_state, $form_id) {
/**
 * hidden other thing when post a new weibo (type) node..
 */
	if($form_id == 'weibo_node_form'){
		$form['comment_settings']['#access']=FALSE;	
		$form['menu']['#access']=FALSE;	
		$form['revision_information']['#access']=FALSE;	
		$form['buttons']['preview']['#access']=FALSE;	
		$form['author']['#access']=FALSE;
		$form['options']['#access']=FALSE;
		drupal_add_js(drupal_get_path('module', 'sina_vp') .'/sina_vp.js');
		drupal_add_css(drupal_get_path('module', 'sina_vp') .'/css/weibo-add.css','module','screen');
		$form['title'] = array(
		  '#type' => 'textarea',//textfield
		  '#description' => '请文明发言，还可以输入<strong id="sina_open_tweet_text_count"></strong>字',
		  '#title' => t('Title'),
		  '#default_value' => $form['title']['#default_value'],
		  '#maxlength' => 140,
		  //'#element_validate' =>array('sina_vp_weibo_length_validate'),
		  //'#prefix' => '<div id="weibo-add-page">',
  		//'#suffix' => '</div>',
		  //'#field_prefix' => 'users photo here',	  
		  //'#field_suffix' => t('MB')
		  '#required' => TRUE,
		  '#resizable' => FALSE,
		);
		$form['title']['#attributes'] = array('class' => 'publish-weibo');
		$form['flag']['#access']=FALSE;
		$form['body_field']['#access']=FALSE;				
		$form['taxonomy']['#access']=FALSE;
	}
	if($form['sina_open'] && $form_id == 'weibo_node_form'){
		$form['add_option']=array(
			'#type' =>'item',
		    '#value' =>'<span id="face"><a class="facexy" href="javascript:;">表情</a></span>|<span id="img"><a onclick="">图片</a></span>|<span id="topic"><a class="topic"  href="javascript:;">话题</a></span>|<span id="atta">@TA</span>
			            	<div id="faceWrap" style="display:none;"><a href="javascript:;" title="[呵呵]"><img width="22px" height="22px" src="http://img.t.sinajs.cn/t3/style/images/common/face/ext/normal/eb/smile.gif"></a><a href="javascript:;" title="[嘻嘻]"><img width="22px" height="22px" src="http://img.t.sinajs.cn/t3/style/images/common/face/ext/normal/c2/tooth.gif"></a><a href="javascript:;" title="[哈哈]"><img width="22px" height="22px" src="http://img.t.sinajs.cn/t3/style/images/common/face/ext/normal/6a/laugh.gif"></a><a href="javascript:;" title="[爱你]"><img width="22px" height="22px" src="http://img.t.sinajs.cn/t3/style/images/common/face/ext/normal/7e/love.gif"></a><a href="javascript:;" title="[晕]"><img width="22px" height="22px" src="http://img.t.sinajs.cn/t3/style/images/common/face/ext/normal/a4/dizzy.gif"></a><a href="javascript:;" title="[泪]"><img width="22px" height="22px" src="http://img.t.sinajs.cn/t3/style/images/common/face/ext/normal/d8/sad.gif"></a><a href="javascript:;" title="[馋嘴]"><img width="22px" height="22px" src="http://img.t.sinajs.cn/t3/style/images/common/face/ext/normal/b8/cz_org.gif"></a><a href="javascript:;" title="[抓狂]"><img width="22px" height="22px" src="http://img.t.sinajs.cn/t3/style/images/common/face/ext/normal/4d/crazy.gif"></a><a href="javascript:;" title="[哼]"><img width="22px" height="22px" src="http://img.t.sinajs.cn/t3/style/images/common/face/ext/normal/19/hate.gif"></a><a href="javascript:;" title="[可爱]"><img width="22px" height="22px" src="http://img.t.sinajs.cn/t3/style/images/common/face/ext/normal/9c/tz_org.gif"></a><a href="javascript:;" title="[怒]"><img width="22px" height="22px" src="http://img.t.sinajs.cn/t3/style/images/common/face/ext/normal/57/angry.gif"></a><a href="javascript:;" title="[汗]"><img width="22px" height="22px" src="http://img.t.sinajs.cn/t3/style/images/common/face/ext/normal/13/sweat.gif"></a><a href="javascript:;" title="[困]"><img width="22px" height="22px" src="http://img.t.sinajs.cn/t3/style/images/common/face/ext/normal/8b/sleepy.gif"></a><a href="javascript:;" title="[害羞]"><img width="22px" height="22px" src="http://img.t.sinajs.cn/t3/style/images/common/face/ext/normal/05/shame_org.gif"></a><a href="javascript:;" title="[睡觉]"><img width="22px" height="22px" src="http://img.t.sinajs.cn/t3/style/images/common/face/ext/normal/7d/sleep_org.gif"></a><a href="javascript:;" title="[钱]"><img width="22px" height="22px" src="http://img.t.sinajs.cn/t3/style/images/common/face/ext/normal/90/money_org.gif"></a><a href="javascript:;" title="[偷笑]"><img width="22px" height="22px" src="http://img.t.sinajs.cn/t3/style/images/common/face/ext/normal/7e/hei_org.gif"></a><a href="javascript:;" title="[酷]"><img width="22px" height="22px" src="http://img.t.sinajs.cn/t3/style/images/common/face/ext/normal/40/cool_org.gif"></a><a href="javascript:;" title="[衰]"><img width="22px" height="22px" src="http://img.t.sinajs.cn/t3/style/images/common/face/ext/normal/af/cry.gif"></a><a href="javascript:;" title="[吃惊]"><img width="22px" height="22px" src="http://img.t.sinajs.cn/t3/style/images/common/face/ext/normal/f4/cj_org.gif"></a><a href="javascript:;" title="[闭嘴]"><img width="22px" height="22px" src="http://img.t.sinajs.cn/t3/style/images/common/face/ext/normal/29/bz_org.gif"></a><a href="javascript:;" title="[鄙视]"><img width="22px" height="22px" src="http://img.t.sinajs.cn/t3/style/images/common/face/ext/normal/71/bs2_org.gif"></a><a href="javascript:;" title="[挖鼻屎]"><img width="22px" height="22px" src="http://img.t.sinajs.cn/t3/style/images/common/face/ext/normal/b6/kbs_org.gif"></a><a href="javascript:;" title="[花心]"><img width="22px" height="22px" src="http://img.t.sinajs.cn/t3/style/images/common/face/ext/normal/64/hs_org.gif"></a><a href="javascript:;" title="[鼓掌]"><img width="22px" height="22px" src="http://img.t.sinajs.cn/t3/style/images/common/face/ext/normal/1b/gz_org.gif"></a><a href="javascript:;" title="[失望]"><img width="22px" height="22px" src="http://img.t.sinajs.cn/t3/style/images/common/face/ext/normal/0c/sw_org.gif"></a><a href="javascript:;" title="[思考]"><img width="22px" height="22px" src="http://img.t.sinajs.cn/t3/style/images/common/face/ext/normal/e9/sk_org.gif"></a><a href="javascript:;" title="[生病]"><img width="22px" height="22px" src="http://img.t.sinajs.cn/t3/style/images/common/face/ext/normal/b6/sb_org.gif"></a><a href="javascript:;" title="[亲亲]"><img width="22px" height="22px" src="http://img.t.sinajs.cn/t3/style/images/common/face/ext/normal/8f/qq_org.gif"></a><a href="javascript:;" title="[怒骂]"><img width="22px" height="22px" src="http://img.t.sinajs.cn/t3/style/images/common/face/ext/normal/89/nm_org.gif"></a><a href="javascript:;" title="[太开心]"><img width="22px" height="22px" src="http://img.t.sinajs.cn/t3/style/images/common/face/ext/normal/58/mb_org.gif"></a><a href="javascript:;" title="[懒得理你]"><img width="22px" height="22px" src="http://img.t.sinajs.cn/t3/style/images/common/face/ext/normal/17/ldln_org.gif"></a><a href="javascript:;" title="[右哼哼]"><img width="22px" height="22px" src="http://img.t.sinajs.cn/t3/style/images/common/face/ext/normal/98/yhh_org.gif"></a><a href="javascript:;" title="[左哼哼]"><img width="22px" height="22px" src="http://img.t.sinajs.cn/t3/style/images/common/face/ext/normal/6d/zhh_org.gif"></a><a href="javascript:;" title="[嘘]"><img width="22px" height="22px" src="http://img.t.sinajs.cn/t3/style/images/common/face/ext/normal/a6/x_org.gif"></a><a href="javascript:;" title="[委屈]"><img width="22px" height="22px" src="http://img.t.sinajs.cn/t3/style/images/common/face/ext/normal/73/wq_org.gif"></a><a href="javascript:;" title="[吐]"><img width="22px" height="22px" src="http://img.t.sinajs.cn/t3/style/images/common/face/ext/normal/9e/t_org.gif"></a><a href="javascript:;" title="[可怜]"><img width="22px" height="22px" src="http://img.t.sinajs.cn/t3/style/images/common/face/ext/normal/af/kl_org.gif"></a><a href="javascript:;" title="[打哈气]"><img width="22px" height="22px" src="http://img.t.sinajs.cn/t3/style/images/common/face/ext/normal/f3/k_org.gif"></a><a href="javascript:;" title="[做鬼脸]"><img width="22px" height="22px" src="http://img.t.sinajs.cn/t3/style/images/common/face/ext/normal/88/zgl_org.gif"></a><a href="javascript:;" title="[握手]"><img width="22px" height="22px" src="http://img.t.sinajs.cn/t3/style/images/common/face/ext/normal/0c/ws_org.gif"></a><a href="javascript:;" title="[耶]"><img width="22px" height="22px" src="http://img.t.sinajs.cn/t3/style/images/common/face/ext/normal/d9/ye_org.gif"></a><a href="javascript:;" title="[good]"><img width="22px" height="22px" src="http://img.t.sinajs.cn/t3/style/images/common/face/ext/normal/d8/good_org.gif"></a><a href="javascript:;" title="[弱]"><img width="22px" height="22px" src="http://img.t.sinajs.cn/t3/style/images/common/face/ext/normal/d8/sad_org.gif"></a><a href="javascript:;" title="[不要]"><img width="22px" height="22px" src="http://img.t.sinajs.cn/t3/style/images/common/face/ext/normal/c7/no_org.gif"></a><a href="javascript:;" title="[ok]"><img width="22px" height="22px" src="http://img.t.sinajs.cn/t3/style/images/common/face/ext/normal/d6/ok_org.gif"></a><a href="javascript:;" title="[赞]"><img width="22px" height="22px" src="http://img.t.sinajs.cn/t3/style/images/common/face/ext/normal/d0/z2_org.gif"></a><a href="javascript:;" title="[来]"><img width="22px" height="22px" src="http://img.t.sinajs.cn/t3/style/images/common/face/ext/normal/40/come_org.gif"></a><a href="javascript:;" title="[蛋糕]"><img width="22px" height="22px" src="http://img.t.sinajs.cn/t3/style/images/common/face/ext/normal/6a/cake.gif"></a><a href="javascript:;" title="[心]"><img width="22px" height="22px" src="http://img.t.sinajs.cn/t3/style/images/common/face/ext/normal/6d/heart.gif"></a><a href="javascript:;" title="[伤心]"><img width="22px" height="22px" src="http://img.t.sinajs.cn/t3/style/images/common/face/ext/normal/ea/unheart.gif"></a><a href="javascript:;" title="[钟]"><img width="22px" height="22px" src="http://img.t.sinajs.cn/t3/style/images/common/face/ext/normal/d3/clock_org.gif"></a><a href="javascript:;" title="[猪头]"><img width="22px" height="22px" src="http://img.t.sinajs.cn/t3/style/images/common/face/ext/normal/58/pig.gif"></a><a href="javascript:;" title="[咖啡]"><img width="22px" height="22px" src="http://img.t.sinajs.cn/t3/style/images/common/face/ext/normal/64/cafe_org.gif"></a><a href="javascript:;" title="[话筒]"><img width="22px" height="22px" src="http://img.t.sinajs.cn/t3/style/images/common/face/ext/normal/1b/m_org.gif"></a><a href="javascript:;" title="[干杯]"><img width="22px" height="22px" src="http://img.t.sinajs.cn/t3/style/images/common/face/ext/normal/bd/cheer.gif"></a><a href="javascript:;" title="[绿丝带]"><img width="22px" height="22px" src="http://img.t.sinajs.cn/t3/style/images/common/face/ext/normal/b8/green.gif"></a><a href="javascript:;" title="[蜡烛]"><img width="22px" height="22px" src="http://img.t.sinajs.cn/t3/style/images/common/face/ext/normal/cc/candle.gif"></a><a href="javascript:;" title="[微风]"><img width="22px" height="22px" src="http://img.t.sinajs.cn/t3/style/images/common/face/ext/normal/a5/wind_org.gif"></a><a href="javascript:;" title="[月亮]"><img width="22px" height="22px" src="http://img.t.sinajs.cn/t3/style/images/common/face/ext/normal/b9/moon.gif"></a><a href="javascript:;" title="[织]"><img width="22px" height="22px" src="http://img.t.sinajs.cn/t3/style/images/common/face/ext/normal/41/zz2_org.gif"></a><a href="javascript:;" title="[围观]"><img width="22px" height="22px" src="http://img.t.sinajs.cn/t3/style/images/common/face/ext/normal/f2/wg_org.gif"></a><a href="javascript:;" title="[威武]"><img width="22px" height="22px" src="http://img.t.sinajs.cn/t3/style/images/common/face/ext/normal/70/vw_org.gif"></a><a href="javascript:;" title="[奥特曼]"><img width="22px" height="22px" src="http://img.t.sinajs.cn/t3/style/images/common/face/ext/normal/bc/otm_org.gif"></a><a href="javascript:;" title="[宅]"><img width="22px" height="22px" src="http://img.t.sinajs.cn/t3/style/images/common/face/ext/normal/d7/z_org.gif"></a><a href="javascript:;" title="[帅]"><img width="22px" height="22px" src="http://img.t.sinajs.cn/t3/style/images/common/face/ext/normal/36/s2_org.gif"></a><a href="javascript:;" title="[跳舞花]"><img width="22px" height="22px" src="http://img.t.sinajs.cn/t3/style/images/common/face/ext/normal/70/twh_org.gif"></a><a href="javascript:;" title="[围脖]"><img width="22px" height="22px" src="http://img.t.sinajs.cn/t3/style/images/common/face/ext/normal/3f/weijin_org.gif"></a><a href="javascript:;" title="[温暖帽子]"><img width="22px" height="22px" src="http://img.t.sinajs.cn/t3/style/images/common/face/ext/normal/f1/wennuanmaozi_org.gif"></a><a href="javascript:;" title="[手套]"><img width="22px" height="22px" src="http://img.t.sinajs.cn/t3/style/images/common/face/ext/normal/72/shoutao_org.gif"></a><a href="javascript:;" title="[雪]"><img width="22px" height="22px" src="http://img.t.sinajs.cn/t3/style/images/common/face/ext/normal/00/snow_org.gif"></a><a href="javascript:;" title="[雪人]"><img width="22px" height="22px" src="http://img.t.sinajs.cn/t3/style/images/common/face/ext/normal/d9/xx2_org.gif"></a><a href="javascript:;" title="[左抱抱]"><img width="22px" height="22px" src="http://img.t.sinajs.cn/t3/style/images/common/face/ext/normal/54/left_org.gif"></a><a href="javascript:;" title="[右抱抱]"><img width="22px" height="22px" src="http://img.t.sinajs.cn/t3/style/images/common/face/ext/normal/0d/right_org.gif"></a><a href="javascript:;" title="[礼物]"><img width="22px" height="22px" src="http://img.t.sinajs.cn/t3/style/images/common/face/ext/normal/c4/liwu_org.gif"></a><a href="javascript:;" title="[爱心传递]"><img width="22px" height="22px" src="http://img.t.sinajs.cn/t3/style/images/common/face/ext/normal/c9/axcd_org.gif"></a><a href="javascript:;" title="[照相机]"><img width="22px" height="22px" src="http://img.t.sinajs.cn/t3/style/images/common/face/ext/normal/33/camera_org.gif"></a><a href="javascript:;" title="[落叶]"><img width="22px" height="22px" src="http://img.t.sinajs.cn/t3/style/images/common/face/ext/normal/79/yellowMood_org.gif"></a><a href="javascript:;" title="[白云]"><img width="22px" height="22px" src="http://img.t.sinajs.cn/t3/style/images/common/face/ext/normal/ff/y3_org.gif"></a><a href="javascript:;" title="[给力]"><img width="22px" height="22px" src="http://img.t.sinajs.cn/t3/style/images/common/face/ext/normal/c9/geili_org.gif"></a></div>',
		);
		$form['sina_vp_open'] = array(
      '#type' => 'checkbox',
      '#title' => '同步到新浪',
      '#required' => true,
      '#default_value' => 1,
    );
		unset($form['sina_open']);
	}
	/**
	 * hidden  comment-form for weibo node
	 */
	$node = node_load($form[nid]['#value']);
	if(($form_id == 'comment_form')&&($node->type=='weibo')){
		$form['sina_vp_open'] = array(
      '#type' => 'checkbox',
      '#title' => '同步到新浪',
      '#required' => true,
      '#default_value' => 1,
    );
		unset($form['sina_open']);
		$form['comment_filter']['comment']['#type'] = 'textarea';
		$form['comment_filter']['comment']['#rows'] = '3';
		//$form['comment_filter']['comment']['#resizable'] = FALSE;
		$form['comment_filter']['comment']['#maxlength'] = '140';
		$form['_author']['#type']['#access']=FALSE;
		$form['comment_filter']['format']['#access']=FALSE;
		$form['comment_filter']['comment']['#description'] = '最多140个字符，中英文均算一个字符。还可以输入<strong id="sina_open_tweet_text_count"></strong>个字符。';
		$form['preview']['#type']['#access']=FALSE;
		//drupal_add_js(drupal_get_path('module', 'sina_vp') .'/sina_vp_comment.js');
	}
	//
	if(($form_id == 'weibo_node_form' && arg(0)=='vp'&& (arg(1)=='add' || arg(1)=='Reality'))
			||($form_id == 'weibo_node_form' && arg(0)=='vp'&& arg(1)=='forward')	){
		//hook_taxonomy
		//taxonomy_overview_vocabularies()
	  $vocabularies = taxonomy_get_vocabularies();
	  //$form = array('#tree' => TRUE);
	  foreach ($vocabularies as $vocabulary) {
	    if(check_plain($vocabulary->name)==t('微薄频道')){
	    	$vid=$vocabulary->vid;
				break;
	    }
	  }
		if(!$vid){			
			drupal_set_message('没有设置微博频道哎！^_^','error');
			return t('E11090732:没有设置微博频道哎^_^');
		}
		//define('PRODUCT', 0); need more
		$sina_vp_type=arg(2);
		switch (arg(2)) {
			case 'Product':
				// 2 可以进一步处理
				$form['taxonomy'][$vid]['#default_value'] = 1;
				$form['taxonomy'][$vid]['#description'] = 'Product新品';
				//博文类型
				$form['sina_vp_type'] = array(
					'#type' => 'value',
					'#default_value' =>1,
					'#access' => FALSE,
					'#description' => 'Product新品',
				);
				break;
			case 'Activity':
				$form['taxonomy'][$vid]['#default_value'] = 2;
				$form['taxonomy'][$vid]['#description'] = 'Activity活动';
				//博文类型
				$form['sina_vp_type'] = array(
					'#type' => 'value',
					'#default_value' =>2,
					'#access' => FALSE,
					'#description' => 'Activity活动',
				);
				break;
			case 'Special':
				$form['taxonomy'][$vid]['#default_value'] = 3;
				$form['taxonomy'][$vid]['#description'] = 'Special爆款';
				//博文类型
				$form['sina_vp_type'] = array(
					'#type' => 'value',
					'#default_value' =>3,
					'#access' => FALSE,
					'#description' => 'Special爆款',
				);
				break;
			case 'Sale':
				$form['taxonomy'][$vid]['#default_value'] = 4;
				$form['taxonomy'][$vid]['#description'] = 'Sale特卖';
				//博文类型
				$form['sina_vp_type'] = array(
					'#type' => 'value',
					'#default_value' =>4,
					'#access' => FALSE,
					'#description' => 'Sale特卖',
				);
				break;
			case 'Transfer':
				$form['taxonomy'][$vid]['#default_value'] = 5;
				$form['taxonomy'][$vid]['#description'] = 'Transfer转让';
				//博文类型
				$form['sina_vp_type'] = array(
					'#type' => 'value',
					'#default_value' =>5,
					'#access' => FALSE,
					'#description' => 'Transfer转让',
				);
				break;
			case 'Show':
				$form['taxonomy'][$vid]['#default_value'] = 6;
				$form['taxonomy'][$vid]['#description'] = 'Show真人秀';
				//博文类型
				$form['sina_vp_type'] = array(
					'#type' => 'value',
					'#default_value' =>6,
					'#access' => FALSE,
					'#description' => 'Show真人秀',
				);
				break;
			default:
				drupal_set_message('链接请求错误，请到指定页面发布微博^_^','error');
				break;
		}
	}
//
		$weibo_type_array=array('Product','Activity','Special','Sale','Transfer','Show'); 	
	  if(arg(0)=='vp' && arg(1)=='forward' && $form_id == 'weibo_node_form'){ 
	  	//转发api /vp/forward/Product/139 不可以带图片
			$form['field_weibo_image']['#access']=FALSE;
		}
	$dispalyNone_forms = array(
		'weibo_page_default',
		'devel_execute_block_form',
		'search_theme_form',
		'search_block_form',
		'devel_switch_user_form',
		'user_login_block'
	);
	if(in_array($form_id, $dispalyNone_forms)){
		//donothing...
	}else{
		if(function_exists(dpm)) dpm($form,$form_id);
	}
  return $form;
}
/**
 * weibo type taxonomy termid 2=微薄频道下的  (1-6)新品，活动，爆款，特卖，转让，真人秀
 * @param $sina_vp_type
 *   int
 * @return
 *   string
 */
function sina_vp_get_type_by_int($sina_vp_type){
	if(is_int($sina_vp_type)){
		switch ($sina_vp_type) {
			case '1':
				$sina_vp_type = 'Product';
				break;
			case '2':
				$sina_vp_type = 'Activity';
				break;
			case '3':
				$sina_vp_type = 'Special';
				break;
			case '4':
				$sina_vp_type = 'Sale';
				break;
			case '5':
				$sina_vp_type = 'Transfer';
				break;
			case '6':
				$sina_vp_type = 'Show';
				break;
			default:
				drupal_set_message('no get_sina_vp_type','error');
				break;
		}
	}
	return $sina_vp_type;
}
/**
 * weibo type taxonomy termid 2=微薄频道下的  (1-6)新品，活动，爆款，特卖，转让，真人秀
 * @param $sina_vp_type
 *   string
 * @return
 *   int
 */
function sina_vp_get_type_by_string($sina_vp_type){
	if(is_string($sina_vp_type)){
		switch ($sina_vp_type) {
			case 'Product':
				$sina_vp_type = 1;
				break;
			case 'Activity':
				$sina_vp_type = 2;
				break;
			case 'Special':
				$sina_vp_type = 3;
				break;
			case 'Sale':
				$sina_vp_type = 4;
				break;
			case 'Transfer':
				$sina_vp_type = 5;
				break;
			case 'Show':
				$sina_vp_type = 6;
				break;
			default:
				drupal_set_message('no get_sina_vp_type','error');
				break;
		}
	}
	return $sina_vp_type;
}
/**
  * @return
 *   string
 */
function sina_vp_get_type_by_node($nid){
	$node = node_load($nid);
	foreach($node->taxonomy as $key=>$value){
		return sina_vp_get_type_by_int($key);
	};
}
/**
 * hook_link_alter
 */
function sina_vp_link_alter(&$links, $node, $comment=NULL){
	global $user;
	if($node->type == 'weibo'){// && $node   && !$links['forward_link']
		if(user_access('add new forward')){			
			$links['forward_link'] = array(
		    'title' => t('转发'), 
		    'href' => 'vp/forward/'.sina_vp_get_type_by_node($node->nid).'/'.$node->nid, 
		    //'query' => 'redirect=node', 
		    //'fragment' => 'anchorname', 
		    'attributes' => array('title' => t('转发')),
	  	);
		}
		if(user_access('add new show')){	//vp/add/Show/%		
			$links['show_link'] = array(
		    'title' => t('秀一下'), 
		    'href' => 'vp/Reality/Show/'.$node->nid, 
		    //'query' => 'redirect=node', 
		    //'fragment' => 'anchorname', 
		    'attributes' => array('title' => t('秀一下')),
	  	);
		}
	}
	return $links;
}
/**
 * 验证》140字  noyong
 * */
function sina_vp_weibo_length_validate($element, &$form_state) {
  if (isset($element['#value']['title'])) {    
      form_error($element['title'], t('The area code is invalid.'));
  }
  return $element;
}
/**
 * 发带图片的微博   节点 
 * @param (string) $text
 *  文字内容
 * @param (string) $url
 *  访问地址
 * @param (mixd) $node 
 *  节点
 */
function sina_open_t_set_tweet2($text, $url = NULL,$node=NUll) { //dale $node=NUll
	$zid=arg(3);dpm($zid,'$zid');
  if (isset($url)) {
    $len = drupal_strlen($url);
  } else {
    $len = 0;
  }
  $len = 140 - drupal_strlen($text) - $len;//+ ? - 
  
  if ($len < 0) {
    $text = drupal_substr($text, 0, $len);
  }
  //对评论或发布判断。
  $donext=false;
	if(isset($node->type)){//if is $node 拥有type属性
		$donext=true;
	}elseif(isset($node[cid])){//if is $comment is_array &&cid属性
		$request_url='http://api.t.sina.com.cn/statuses/comment.json'; 
		$wid= sina_vp_get_wid($node[nid]);
		$params['id'] = $wid;
		$params['comment'] = urlencode($text. $url);
		$params['without_mention'] = 0;
		$params['comment_ori'] = 1;
		watchdog('$zid-pl',print_r($zid,true));
		/* some API
			id 	true 	int64 	要评论的微博消息ID
			comment 	true 	string 	评论内容。必须做URLEncode,信息内容不超过140个汉字。
			cid 	false 	int64 	要回复的评论ID。
			without_mention 	false 	int 	1：回复中不自动加入“回复@用户名”，0：回复中自动加入“回复@用户名”.默认为0.
			comment_ori 	false 	int 	当评论一条转发微博时，是否评论给原微博。0:不评论给原微博。1：评论给原微博。默认0. 
		*/
		$result = sina_open_t_set_request($request_url,$params);
		//watchdog('$params22','<pre>'.print_r($result,true));
		$sina_vp_type=sina_vp_get_type_by_node($node[nid]);
		_sina_vp_db_write($result->data,$node,$sina_vp_type);//dale $node or $comment  
		if ($result->code == 200) {
			//watchdog('success','已成功发送到新浪微博2026'); 			
			if(function_exists(dpm)) dpm(json_decode($result->data));//没效果，注销了 
			drupal_set_message('评论已成功发送到新浪微博');	//没效果，注销了	
		} else {
			drupal_set_message('评论转发失败 code:201109262026');
			watchdog('warning','评论转发失败 code:201109262026');
		}	
	}
	if($donext){//发布节点，同步新浪微博	
	  $weibo_type_array=array('Product','Activity','Special','Sale','Transfer','Show'); 	
	  if(arg(0)=='vp' && arg(1)=='forward'){ //转发api /vp/forward/Product/139
			if(!in_array($sina_vp_type=arg(2), $weibo_type_array)){
				drupal_set_message('转发失败 ,指定频道不对！');
				return t('转发失败 ,指定频道不对！');
			}
			if(!(node_load($zid=arg(3)))){
				drupal_set_message('转发失败 ,找到不您要转发的微博（已删除）！');
				return t('转发失败 ,找到不您要转发的微博（已删除）！');
			}
			$params['id'] = sina_vp_get_wid($zid);
			$params['status'] = urlencode($text. $url);
			//是否在转发的同时发表评论。0表示不发表评论，1表示发表评论给当前微博，2表示发表评论给原微博，3是1、2都发表。默认为0。 
			$params['is_comment'] = 0;
			$request_url = 'http://api.t.sina.com.cn/statuses/repost.json';
			$result = sina_open_t_set_request($request_url,$params);
		  _sina_vp_db_write($result->data,$node,$sina_vp_type,$zid);
		  if(function_exists(dpm)) dpm(json_decode($result->data),'微博返回信息');		
		  if ($result->code == 200) {	    					  			
				drupal_set_message('已成功发送到新浪微博');
		  }else{
		    drupal_set_message('发送到新浪微博失败，错误代码：2011100701，请联系管理员xiangkeguo@gmail.com。', 'warning');
		  }
			return;
		}
	  if(is_null($node->field_weibo_image[0])){
	  	$result = sina_open_t_set_request(
		    'http://api.t.sina.com.cn/statuses/update.json',
		    array('status' => urlencode($text. $url))
		  );
		  _sina_vp_db_write($result->data,$node,$sina_vp_type=arg(2),$zid=arg(3));
		  if(function_exists(dpm)) dpm(json_decode($result->data),'微博返回信息');		
		  if ($result->code == 200) {	    					  			
				drupal_set_message('已成功发送到新浪微博');
		  }else{
		    drupal_set_message('发送到新浪微博失败，错误代码：2011100701，请联系管理员xiangkeguo@gmail.com。', 'warning');
		  }
			return;
	  }else{//发 布图片微薄
	  	$status =	urlencode($text. $url);
	  	$pic_path = $node->field_weibo_image[0][filepath];
		  global $user;
			module_load_include('php', 'sina', 'api/weibooauth');
			module_load_include('php', 'sina', 'api/config'); //WB_AKEY , WB_SKEY	
			$token = sina_open_get_access_token($user->uid);
			if(empty($token)){
				module_load_include('inc', 'sina_open', 'sina_open.pages');
				return sina_open_page_config(user_load($user->uid));
			}
			$last_key[oauth_token]=$token->key;
			$last_key[oauth_token_secret]=$token->secret;
			$_SESSION['last_key'] = $last_key;
		
			$c = new WeiboClient( WB_AKEY , WB_SKEY ,$token->key ,$token->secret );
			$result = $c->upload($status , $pic_path);
			if(function_exists(dpm)) dpm($result,'图片微博返回数据');
			//$result['id']=$result['mid'];
			$result['id']=number_format($result['id'], 0, '', '');
			_sina_vp_db_write(json_encode($result),$node,$sina_vp_type=arg(2),$zid=arg(3));
			if (is_array($result)) {
				drupal_set_message('已成功发送到新浪微博ok with pic');
				//if(function_exists(dpm)) dpm(json_decode($result->data));				
			} else {
			  drupal_set_message('同步失败，请检查您的网络！', 'error');
			  //return false;
			}
		return;
	  }
  }
}
/**
 * time format function.
 */
function sina_vp_time_format($created_at){
	//$created_at= Thu Sep 22 14:34:21 +0800 2011
	$created_at=strtotime($created_at);
	$minutes=ceil((time()-$created_at)/60)+2;
	if($minutes<60){
		return $minutes.'分钟前';
	}elseif($show_hours=ceil($minutes/60)<12){
		return $show_hours.'小时前';
	}elseif(ceil($minutes/60)<24 && date("d",time())==date("d",$created_at)){
		return '今天 '.date("H:i",$created_at);
	}else{
		return date("m月d日 H:i",$created_at);
	}
}
/**
 *  replace a url text to <a>link</a> not use l()
 *  天空蔚蓝，天空依然蔚蓝。http://t.cn/adPO8F
 *  ==>天空蔚蓝，天空依然蔚蓝。<a href="http://t.cn/adPO8F">http://t.cn/adPO8F</a>
 * */
function sina_vp_url_format($string){
	$reg='/http:\/\/([\w.]+\/?)\S*/';
	$total_length=strlen($string);

	//删除最后一个出现的url
	for($i=4;$i<$total_length;$i++)
	{
		$temp=substr($string,-1*$i,$i);
		if(preg_match($reg,$temp)>0)
		{
			$string=substr($string,0,$total_length-$i);
			$i=$total_length+100;
		}
	}
	
	$result=preg_replace_callback($reg,"sina_vp_url_replace",$string);//此处调用下面的函数
	return $result;
}
function sina_vp_url_replace($string){
	$new_url='<a href="'.$string[0].'">'.$string[0].'</a>';
	return $new_url;
}
/**
 *  weibo_id
 * */
function get_nid_by_wid($wid){
  $sql="SELECT nid
          FROM {sina_vp_weibo2node}
          WHERE wid ='".$wid."'";
  $result =db_query($sql);
  if($row= db_fetch_array($result)){
     return $row['nid'];
  }
	drupal_set_message('error! when get nid by wid.'.__FILE__.__LINE__);
	return 0;
}

/**
 * get wid by nid
 */
function sina_vp_get_wid($nid){
	$result=db_query("SELECT `wid` wid FROM {sina_vp_weibo2node} WHERE `nid`=%d and `cid`=0",$nid);
	return db_result($result);
}
/**
 *  node_link_alter
 * */
function node_link_alter($type, $node = NULL, $teaser = FALSE) {
  $links = array();
  if ($type == 'weibo') {
    if ($teaser == 1 && $node->teaser && !empty($node->readmore)) {
      $links['node_read_more'] = array(
        'title' => t('Read more'), 
        'href' => "node/$node->nid",
        'attributes' => array('title' => t('Read the rest of !title.', array('!title' => $node->title))),
      );
    }
  }
  return $links;
}
/**
 * Implementation of hook_theme()
 */
function sina_vp_theme() {
  return array(
  	'weibo_page_default' => array(
    	'arguments' => array('form' => NULL)
    ),
  );
}

/**
 * @} End of "sina.module".
 */
